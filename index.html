<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kelas 5B - TP 2025/2026</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Nunito', sans-serif;
        }

        :root {
            --pastel-pink: #ffd1dc;
            --pastel-blue: #aec6cf;
            --pastel-green: #b5ead7;
            --pastel-yellow: #ffeaa7;
            --pastel-purple: #dcd0ff;
            --pastel-orange: #ffdab9;
            --soft-white: #fefefe;
            --soft-gray: #f8f9fa;
        }

        body {
            background: linear-gradient(135deg, var(--pastel-pink) 0%, var(--pastel-blue) 50%, var(--pastel-purple) 100%);
            min-height: 100vh;
            padding: 15px;
            background-attachment: fixed;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Loading */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--pastel-blue), var(--pastel-purple));
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-overlay.hidden { display: none; }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255,255,255,0.4);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .loading-text {
            color: white;
            margin-top: 15px;
            font-weight: 700;
            font-size: 1.1em;
        }

        /* Header */
        .header {
            background: var(--soft-white);
            border-radius: 25px;
            padding: 30px;
            text-align: center;
            margin-bottom: 25px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }

        .header h1 {
            color: #5a5a8a;
            font-size: 2.2em;
            margin-bottom: 8px;
        }

        .header h2 {
            color: #888;
            font-size: 1.1em;
            font-weight: 600;
        }

        .info-badges {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-top: 18px;
            flex-wrap: wrap;
        }

        .info-badge {
            background: linear-gradient(135deg, var(--pastel-green), var(--pastel-blue));
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 0.95em;
            font-weight: 700;
            color: #4a6572;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        /* Connection Status */
        .connection-status {
            position: fixed;
            top: 12px;
            right: 12px;
            padding: 10px 18px;
            border-radius: 25px;
            font-size: 0.85em;
            font-weight: 700;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }

        .connection-status.connected {
            background: linear-gradient(135deg, var(--pastel-green), #98d8aa);
            color: #2d6a4f;
        }

        .connection-status.disconnected {
            background: linear-gradient(135deg, var(--pastel-pink), #ffb3ba);
            color: #c0392b;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: currentColor;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(0.9); }
        }

        /* Navigation */
        .nav-tabs {
            display: flex;
            gap: 12px;
            margin-bottom: 25px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .nav-tab {
            padding: 15px 30px;
            background: var(--soft-white);
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 1.05em;
            font-weight: 700;
            color: #666;
            transition: all 0.3s ease;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
        }

        .nav-tab:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.12);
        }

        .nav-tab.active {
            background: linear-gradient(135deg, var(--pastel-purple), var(--pastel-blue));
            color: #4a4a6a;
        }

        /* Tab Content */
        .tab-content {
            display: none;
            animation: fadeIn 0.4s ease;
        }

        .tab-content.active { display: block; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Card */
        .card {
            background: var(--soft-white);
            border-radius: 25px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.08);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 18px;
            border-bottom: 3px dashed var(--pastel-blue);
            flex-wrap: wrap;
            gap: 15px;
        }

        .card-title {
            font-size: 1.5em;
            font-weight: 800;
            color: #5a5a8a;
        }

        /* Date Section */
        .date-section {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
            background: var(--soft-gray);
            padding: 15px 20px;
            border-radius: 18px;
        }

        .date-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .date-group label {
            font-weight: 700;
            color: #555;
            font-size: 1em;
        }

        .date-input {
            padding: 12px 18px;
            border: 3px solid var(--pastel-blue);
            border-radius: 12px;
            font-size: 1em;
            font-weight: 600;
            background: white;
        }

        .date-input:focus {
            outline: none;
            border-color: var(--pastel-purple);
            box-shadow: 0 0 15px rgba(220, 208, 255, 0.5);
        }

        .libur-section {
            display: flex;
            align-items: center;
            gap: 10px;
            padding-left: 18px;
            border-left: 3px solid var(--pastel-pink);
        }

        .libur-checkbox {
            width: 22px;
            height: 22px;
            accent-color: #e74c3c;
            cursor: pointer;
        }

        .libur-label {
            font-weight: 700;
            color: #e74c3c;
            font-size: 1em;
            cursor: pointer;
        }

        .libur-input {
            padding: 12px 15px;
            border: 3px solid var(--pastel-pink);
            border-radius: 12px;
            width: 220px;
            font-size: 1em;
            font-weight: 600;
        }

        .libur-input:disabled {
            background: #f5f5f5;
        }

        /* Libur Banner */
        .libur-banner {
            background: linear-gradient(135deg, var(--pastel-pink), var(--pastel-orange));
            padding: 25px;
            border-radius: 18px;
            text-align: center;
            margin-bottom: 20px;
            display: none;
            box-shadow: 0 5px 20px rgba(255, 107, 107, 0.2);
        }

        .libur-banner.show { display: block; }

        .libur-banner h3 {
            color: #c0392b;
            font-size: 1.4em;
            margin-bottom: 5px;
        }

        .libur-banner p {
            color: #e74c3c;
            font-weight: 700;
            font-size: 1.1em;
        }

        /* Table Wrapper dengan Sticky */
        .table-wrapper {
            position: relative;
            border-radius: 18px;
            overflow: hidden;
            box-shadow: 0 5px 25px rgba(0,0,0,0.08);
        }

        .table-scroll {
            overflow-x: auto;
            max-height: 70vh;
            overflow-y: auto;
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            min-width: 700px;
        }

        th, td {
            padding: 14px 12px;
            text-align: center;
            border-bottom: 2px solid #f0f0f0;
            font-size: 1em;
        }

        th {
            background: linear-gradient(135deg, var(--pastel-purple), var(--pastel-blue));
            color: #4a4a6a;
            font-weight: 800;
            font-size: 0.95em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: sticky;
            top: 0;
            z-index: 20;
        }

        tr:nth-child(even) {
            background: var(--soft-gray);
        }

        tr:hover td {
            background: linear-gradient(135deg, rgba(174,198,207,0.2), rgba(220,208,255,0.2));
        }

        /* STICKY COLUMNS */
        .col-no {
            position: sticky;
            left: 0;
            z-index: 15;
            background: linear-gradient(135deg, var(--pastel-yellow), var(--pastel-orange));
            color: #6a5d4d;
            font-weight: 800;
            width: 55px;
            min-width: 55px;
        }

        th.col-no {
            z-index: 25;
        }

        .col-nama {
            position: sticky;
            left: 55px;
            z-index: 15;
            background: var(--soft-white);
            text-align: left;
            min-width: 160px;
            max-width: 160px;
            padding: 10px 15px;
            border-right: 4px solid var(--pastel-blue);
        }

        th.col-nama {
            z-index: 25;
            background: linear-gradient(135deg, var(--pastel-purple), var(--pastel-blue));
        }

        tr:nth-child(even) .col-nama {
            background: var(--soft-gray);
        }

        tr:hover .col-nama {
            background: linear-gradient(135deg, rgba(174,198,207,0.3), rgba(220,208,255,0.3));
        }

        /* Nama 2 Baris */
        .nama-container {
            display: flex;
            flex-direction: column;
            line-height: 1.35;
        }

        .nama-depan {
            font-weight: 800;
            font-size: 1.1em;
            color: #3d3d5c;
        }

        .nama-belakang {
            font-weight: 600;
            font-size: 0.85em;
            color: #7a7a9a;
        }

        /* Status Buttons */
        .status-group {
            display: flex;
            gap: 8px;
            justify-content: center;
        }

        .status-btn {
            padding: 10px 15px;
            border: 3px solid #ddd;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1.05em;
            font-weight: 800;
            transition: all 0.25s ease;
            background: white;
            min-width: 45px;
        }

        .status-btn:hover {
            transform: scale(1.1);
        }

        .status-btn.active-h {
            background: linear-gradient(135deg, var(--pastel-green), #98d8aa);
            border-color: #52b788;
            color: #1b4332;
        }

        .status-btn.active-s {
            background: linear-gradient(135deg, var(--pastel-yellow), #ffe066);
            border-color: #f9c74f;
            color: #7c5e10;
        }

        .status-btn.active-i {
            background: linear-gradient(135deg, var(--pastel-blue), #89c2d9);
            border-color: #5390d9;
            color: #1d3557;
        }

        .status-btn.active-a {
            background: linear-gradient(135deg, var(--pastel-pink), #ffb3ba);
            border-color: #e5383b;
            color: #9d0208;
        }

        /* Status Badge */
        .status-badge {
            padding: 8px 16px;
            border-radius: 25px;
            font-weight: 700;
            font-size: 0.9em;
        }

        .badge-hadir { background: var(--pastel-green); color: #1b4332; }
        .badge-sakit { background: var(--pastel-yellow); color: #7c5e10; }
        .badge-izin { background: var(--pastel-blue); color: #1d3557; }
        .badge-alpha { background: var(--pastel-pink); color: #9d0208; }

        /* Summary */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-top: 25px;
        }

        .summary-card {
            background: var(--soft-white);
            padding: 20px 15px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 5px 20px rgba(0,0,0,0.06);
            border: 4px solid transparent;
            transition: all 0.3s;
        }

        .summary-card:hover {
            transform: translateY(-5px);
        }

        .summary-card h4 {
            font-size: 0.95em;
            color: #777;
            margin-bottom: 8px;
        }

        .summary-card .value {
            font-size: 2.5em;
            font-weight: 800;
        }

        .summary-card .pct {
            font-size: 1.05em;
            font-weight: 700;
        }

        .summary-hadir { border-color: var(--pastel-green); }
        .summary-hadir .value, .summary-hadir .pct { color: #2d6a4f; }

        .summary-sakit { border-color: var(--pastel-yellow); }
        .summary-sakit .value, .summary-sakit .pct { color: #b8860b; }

        .summary-izin { border-color: var(--pastel-blue); }
        .summary-izin .value, .summary-izin .pct { color: #1d3557; }

        .summary-alpha { border-color: var(--pastel-pink); }
        .summary-alpha .value, .summary-alpha .pct { color: #c0392b; }

        /* Buttons */
        .action-buttons {
            display: flex;
            gap: 12px;
            margin-top: 25px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 700;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.15);
        }

        .btn-save {
            background: linear-gradient(135deg, var(--pastel-purple), #b8a9c9);
            color: #4a3f6b;
        }

        .btn-refresh {
            background: linear-gradient(135deg, var(--pastel-blue), #89c2d9);
            color: #1d3557;
        }

        .btn-reset {
            background: linear-gradient(135deg, var(--pastel-pink), #ffb3ba);
            color: #9d0208;
        }

        /* Subject Tabs */
        .subject-tabs {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            justify-content: center;
        }

        .subject-tab {
            padding: 14px 28px;
            background: var(--soft-gray);
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 700;
            font-size: 1.05em;
            color: #666;
            transition: all 0.3s;
        }

        .subject-tab.active-bi {
            background: linear-gradient(135deg, var(--pastel-pink), var(--pastel-orange));
            color: #8b4513;
        }

        .subject-tab.active-ppkn {
            background: linear-gradient(135deg, var(--pastel-blue), var(--pastel-green));
            color: #1d3557;
        }

        .subject-content {
            display: none;
        }

        .subject-content.active { display: block; }

        .subject-title {
            display: inline-block;
            padding: 12px 25px;
            border-radius: 25px;
            font-weight: 800;
            margin-bottom: 18px;
            font-size: 1.15em;
        }

        .title-bi {
            background: linear-gradient(135deg, var(--pastel-pink), var(--pastel-orange));
            color: #8b4513;
        }

        .title-ppkn {
            background: linear-gradient(135deg, var(--pastel-blue), var(--pastel-green));
            color: #1d3557;
        }

        /* Nilai Input */
        .nilai-input {
            width: 58px;
            padding: 10px 5px;
            border: 3px solid #ddd;
            border-radius: 12px;
            text-align: center;
            font-size: 1.1em;
            font-weight: 700;
            transition: all 0.25s;
        }

        .nilai-input:focus {
            outline: none;
            border-color: var(--pastel-purple);
            transform: scale(1.08);
            box-shadow: 0 0 15px rgba(220,208,255,0.5);
        }

        .nilai-input.filled {
            background: var(--pastel-green);
            border-color: #52b788;
        }

        .nilai-input.low {
            background: var(--pastel-pink);
            border-color: #e5383b;
        }

        /* Rata-rata */
        .rata-cell {
            font-weight: 800;
            padding: 8px 14px;
            border-radius: 12px;
            font-size: 1.05em;
        }

        .rata-excellent { background: var(--pastel-green); color: #1b4332; }
        .rata-good { background: var(--pastel-blue); color: #1d3557; }
        .rata-average { background: var(--pastel-yellow); color: #7c5e10; }
        .rata-poor { background: var(--pastel-pink); color: #9d0208; }

        /* Rekap */
        .rekap-table th {
            background: linear-gradient(135deg, var(--pastel-orange), var(--pastel-yellow));
            color: #6a5d4d;
        }

        .progress-bar {
            width: 100%;
            height: 10px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 6px;
        }

        .progress-fill {
            height: 100%;
            border-radius: 10px;
            transition: width 0.5s ease;
        }

        .fill-excellent { background: linear-gradient(90deg, #52b788, #40916c); }
        .fill-good { background: linear-gradient(90deg, #5390d9, #4361ee); }
        .fill-average { background: linear-gradient(90deg, #f9c74f, #f9844a); }
        .fill-poor { background: linear-gradient(90deg, #e5383b, #ba181b); }

        .total-badge {
            background: linear-gradient(135deg, var(--pastel-green), var(--pastel-blue));
            padding: 12px 25px;
            border-radius: 25px;
            font-weight: 800;
            color: #1d3557;
            font-size: 1em;
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: 30px;
            color: white;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.2);
        }

        .footer p {
            margin-bottom: 6px;
            font-size: 1em;
        }

        .heart {
            color: #ff6b6b;
            animation: heartbeat 1s infinite;
        }

        @keyframes heartbeat {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 25px;
            right: 25px;
            padding: 18px 30px;
            border-radius: 18px;
            color: white;
            z-index: 10000;
            display: none;
            font-weight: 700;
            font-size: 1em;
            box-shadow: 0 10px 40px rgba(0,0,0,0.25);
        }

        .toast.success { background: linear-gradient(135deg, #52b788, #40916c); }
        .toast.error { background: linear-gradient(135deg, #e5383b, #ba181b); }
        .toast.info { background: linear-gradient(135deg, #5390d9, #4361ee); }

        /* Responsive */
        @media (max-width: 768px) {
            body { padding: 10px; }
            
            .header { padding: 22px 18px; }
            .header h1 { font-size: 1.7em; }
            
            .nav-tab { padding: 12px 22px; font-size: 1em; }
            
            .card { padding: 20px; }
            
            .date-section { flex-direction: column; align-items: stretch; }
            
            .libur-section {
                border-left: none;
                padding-left: 0;
                border-top: 3px solid var(--pastel-pink);
                padding-top: 12px;
                margin-top: 8px;
            }
            
            .libur-input { width: 100%; }
            
            th, td { padding: 12px 8px; font-size: 0.95em; }
            
            .col-no { width: 45px; min-width: 45px; }
            .col-nama { left: 45px; min-width: 140px; max-width: 140px; }
            
            .nama-depan { font-size: 1em; }
            .nama-belakang { font-size: 0.8em; }
            
            .status-btn { padding: 9px 12px; font-size: 1em; min-width: 40px; }
            
            .nilai-input { width: 52px; font-size: 1em; }
            
            .summary-grid { grid-template-columns: repeat(2, 1fr); }
            
            .summary-card .value { font-size: 2em; }
            
            .btn { padding: 12px 22px; font-size: 0.95em; }
        }

        @media (max-width: 480px) {
            .col-no { width: 40px; min-width: 40px; font-size: 0.9em; }
            .col-nama { left: 40px; min-width: 120px; max-width: 120px; }
            
            .nama-depan { font-size: 0.95em; }
            .nama-belakang { font-size: 0.75em; }
            
            .status-btn { padding: 8px 10px; font-size: 0.95em; min-width: 36px; }
            
            .nilai-input { width: 46px; font-size: 0.95em; padding: 8px 3px; }
        }
    </style>
</head>
<body>
    <!-- Loading -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <div class="loading-text">Menghubungkan ke Google Sheets...</div>
    </div>

    <!-- Connection Status -->
    <div class="connection-status" id="connectionStatus">
        <div class="status-dot"></div>
        <span id="statusText">Connecting...</span>
    </div>

    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üìö Aplikasi Kelas 5B</h1>
            <h2>Tahun Pelajaran 2025/2026 - Semester Genap</h2>
            <div class="info-badges">
                <div class="info-badge">üë®‚Äçüè´ Wali Kelas: M. Yusni</div>
                <div class="info-badge">üë• 22 Siswa</div>
                <div class="info-badge">üìÖ Mulai: 4 Januari 2026</div>
                <div class="info-badge">‚òÅÔ∏è Google Sheets</div>
            </div>
        </div>

        <!-- Navigation -->
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('absensi', this)">üìã Absensi</button>
            <button class="nav-tab" onclick="showTab('nilai', this)">üìä Nilai</button>
            <button class="nav-tab" onclick="showTab('rekap', this)">üìà Rekap</button>
        </div>

        <!-- Tab Absensi -->
        <div id="absensi" class="tab-content active">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">üìã Absensi Harian</div>
                    <div class="date-section">
                        <div class="date-group">
                            <label>üìÖ</label>
                            <input type="date" class="date-input" id="tanggalAbsensi" min="2026-01-04" value="2026-01-04" onchange="loadAbsensiByDate()">
                        </div>
                        <div class="libur-section">
                            <input type="checkbox" class="libur-checkbox" id="isLibur" onchange="toggleLibur()">
                            <label class="libur-label" for="isLibur">üèñÔ∏è Libur</label>
                            <input type="text" class="libur-input" id="alasanLibur" placeholder="Alasan libur..." disabled>
                        </div>
                    </div>
                </div>

                <div class="libur-banner" id="liburBanner">
                    <h3>üèñÔ∏è HARI LIBUR</h3>
                    <p id="liburReason">-</p>
                </div>

                <div class="table-wrapper" id="absensiTableWrapper">
                    <div class="table-scroll">
                        <table>
                            <thead>
                                <tr>
                                    <th class="col-no">No</th>
                                    <th class="col-nama">Nama Siswa</th>
                                    <th>Status Kehadiran</th>
                                    <th>Keterangan</th>
                                </tr>
                            </thead>
                            <tbody id="absensiBody"></tbody>
                        </table>
                    </div>
                </div>

                <div class="summary-grid" id="summaryGrid">
                    <div class="summary-card summary-hadir">
                        <h4>‚úÖ Hadir</h4>
                        <div class="value" id="countHadir">22</div>
                        <div class="pct" id="pctHadir">100%</div>
                    </div>
                    <div class="summary-card summary-sakit">
                        <h4>ü§í Sakit</h4>
                        <div class="value" id="countSakit">0</div>
                        <div class="pct" id="pctSakit">0%</div>
                    </div>
                    <div class="summary-card summary-izin">
                        <h4>üìù Izin</h4>
                        <div class="value" id="countIzin">0</div>
                        <div class="pct" id="pctIzin">0%</div>
                    </div>
                    <div class="summary-card summary-alpha">
                        <h4>‚ùå Alpha</h4>
                        <div class="value" id="countAlpha">0</div>
                        <div class="pct" id="pctAlpha">0%</div>
                    </div>
                </div>

                <div class="action-buttons">
                    <button class="btn btn-save" onclick="saveAbsensi()">üíæ Simpan ke GSheets</button>
                    <button class="btn btn-refresh" onclick="loadAbsensiByDate()">üîÑ Refresh</button>
                    <button class="btn btn-reset" onclick="resetAbsensiTanggal()">üóëÔ∏è Reset Tanggal Ini</button>
                </div>
            </div>
        </div>

        <!-- Tab Nilai -->
        <div id="nilai" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">üìä Daftar Nilai</div>
                    <button class="btn btn-refresh" onclick="loadNilai(currentMapel)">üîÑ Refresh</button>
                </div>

                <div class="subject-tabs">
                    <button class="subject-tab active-bi" id="tabBi" onclick="showSubject('bi')">üìñ Bahasa Indonesia</button>
                    <button class="subject-tab" id="tabPpkn" onclick="showSubject('ppkn')">üèõÔ∏è PPKn</button>
                </div>

                <!-- Bahasa Indonesia -->
                <div id="subject-bi" class="subject-content active">
                    <div class="subject-title title-bi">üìñ Bahasa Indonesia</div>
                    <div class="table-wrapper">
                        <div class="table-scroll">
                            <table>
                                <thead>
                                    <tr>
                                        <th class="col-no">No</th>
                                        <th class="col-nama">Nama</th>
                                        <th>NH1</th>
                                        <th>NH2</th>
                                        <th>NH3</th>
                                        <th>NH4</th>
                                        <th>NH5</th>
                                        <th>STS</th>
                                        <th>SAT</th>
                                        <th>Rata¬≤</th>
                                        <th>%</th>
                                        <th>Pred</th>
                                    </tr>
                                </thead>
                                <tbody id="nilaiBiBody"></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-save" onclick="saveNilai('bi')">üíæ Simpan ke GSheets</button>
                        <button class="btn btn-reset" onclick="resetNilaiMapel('bi')">üóëÔ∏è Reset Nilai BI</button>
                    </div>
                </div>

                <!-- PPKn -->
                <div id="subject-ppkn" class="subject-content">
                    <div class="subject-title title-ppkn">üèõÔ∏è Pendidikan Pancasila dan Kewarganegaraan</div>
                    <div class="table-wrapper">
                        <div class="table-scroll">
                            <table>
                                <thead>
                                    <tr>
                                        <th class="col-no">No</th>
                                        <th class="col-nama">Nama</th>
                                        <th>NH1</th>
                                        <th>NH2</th>
                                        <th>NH3</th>
                                        <th>NH4</th>
                                        <th>NH5</th>
                                        <th>STS</th>
                                        <th>SAT</th>
                                        <th>Rata¬≤</th>
                                        <th>%</th>
                                        <th>Pred</th>
                                    </tr>
                                </thead>
                                <tbody id="nilaiPpknBody"></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-save" onclick="saveNilai('ppkn')">üíæ Simpan ke GSheets</button>
                        <button class="btn btn-reset" onclick="resetNilaiMapel('ppkn')">üóëÔ∏è Reset Nilai PPKn</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab Rekap -->
        <div id="rekap" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">üìà Rekap Kehadiran Semester</div>
                    <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
                        <div class="total-badge">üìÖ Total: <span id="totalHari">0</span> hari</div>
                        <button class="btn btn-refresh" onclick="loadRekap()">üîÑ Refresh</button>
                        <button class="btn btn-reset" onclick="resetSemuaAbsensi()">üóëÔ∏è Reset Semua</button>
                    </div>
                </div>

                <div class="table-wrapper">
                    <div class="table-scroll">
                        <table class="rekap-table">
                            <thead>
                                <tr>
                                    <th class="col-no">No</th>
                                    <th class="col-nama">Nama</th>
                                    <th>H</th>
                                    <th>S</th>
                                    <th>I</th>
                                    <th>A</th>
                                    <th>Total</th>
                                    <th>% Hadir</th>
                                </tr>
                            </thead>
                            <tbody id="rekapBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Daftar Libur -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">üèñÔ∏è Daftar Hari Libur</div>
                </div>
                <div class="table-wrapper">
                    <div class="table-scroll">
                        <table>
                            <thead>
                                <tr>
                                    <th style="width:60px;">No</th>
                                    <th>Tanggal</th>
                                    <th>Keterangan</th>
                                </tr>
                            </thead>
                            <tbody id="liburBody">
                                <tr><td colspan="3" style="padding:35px;color:#999;">Belum ada hari libur</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <p>¬© 2025 Kelas 5B | Wali Kelas: <strong>M. Yusni</strong></p>
            <p>Tahun Pelajaran 2025/2026 Semester Genap</p>
            <p>Dibuat dengan <span class="heart">‚ù§Ô∏è</span> untuk pendidikan Indonesia</p>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script>
        // =====================================================
        // URL APPS SCRIPT ANDA
        // =====================================================
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyWuuakCOH0Xpv95SvG7-aAd96FR08bEokAMPOaJaBey9Dya7AmcVX7QK5vbeeI3Lcz/exec';

        const SISWA = [
            "Abdul Basith", "Abdullah Asyfaq Nawawi", "Abid Aqilla Rajendra",
            "Afreza Dwi Saputra", "Anindita Keisha Azzahra", "Friska Dila Aulia",
            "Jemmy Rachad Nazzih", "Kinara Syaqila Anggraini", "Moh Fauzus Salam",
            "Muhammad Azka Alvaro", "Muhammad Erlangga", "Muhammad Zidna Ilman",
            "Muhammad Zulfan Alfatir", "Nahwa Kamilatun Nisa", "Nilam Ainur Rohmah",
            "Nindia Ramadhani", "Safitri", "Nurin Najwa", "Rafa Aditya Putra",
            "Talita Indah Ayu Septiana", "Wildan Faza Aufar", "Zalfa Rahmuna Yasmin"
        ];

        let absensiData = {};
        let nilaiData = { bi: {}, ppkn: {} };
        let rekapData = {};
        let currentMapel = 'bi';

        // ==================== INIT ====================
        document.addEventListener('DOMContentLoaded', async () => {
            initData();
            renderAbsensi();
            renderNilai('bi');
            renderNilai('ppkn');
            
            await checkConnection();
            await loadAbsensiByDate();
            await loadNilai('bi');
            await loadNilai('ppkn');
        });

        function initData() {
            SISWA.forEach((_, i) => {
                absensiData[i] = 'H';
                nilaiData.bi[i] = {nh1:'',nh2:'',nh3:'',nh4:'',nh5:'',sts:'',sat:''};
                nilaiData.ppkn[i] = {nh1:'',nh2:'',nh3:'',nh4:'',nh5:'',sts:'',sat:''};
                rekapData[i] = {hadir:0,sakit:0,izin:0,alpha:0};
            });
        }

        // ==================== API ====================
        async function checkConnection() {
            try {
                const res = await fetch(`${APPS_SCRIPT_URL}?action=getSiswa`);
                if (res.ok) {
                    document.getElementById('connectionStatus').className = 'connection-status connected';
                    document.getElementById('statusText').textContent = 'Terhubung';
                }
            } catch (e) {
                document.getElementById('connectionStatus').className = 'connection-status disconnected';
                document.getElementById('statusText').textContent = 'Offline';
                showToast('‚ö†Ô∏è Tidak dapat terhubung ke server', 'error');
            }
            hideLoading();
        }

        async function apiGet(action, params = {}) {
            const qs = new URLSearchParams({ action, ...params }).toString();
            const res = await fetch(`${APPS_SCRIPT_URL}?${qs}`);
            return await res.json();
        }

        async function apiPost(data) {
            const res = await fetch(APPS_SCRIPT_URL, { 
                method: 'POST', 
                body: JSON.stringify(data),
                headers: { 'Content-Type': 'text/plain' }
            });
            return await res.json();
        }

        // ==================== UI ====================
        function showLoading() { document.getElementById('loadingOverlay').classList.remove('hidden'); }
        function hideLoading() { document.getElementById('loadingOverlay').classList.add('hidden'); }

        function showToast(msg, type = 'success') {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.className = `toast ${type}`;
            t.style.display = 'block';
            setTimeout(() => t.style.display = 'none', 3500);
        }

        function showTab(id, btn) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            btn.classList.add('active');
            if (id === 'rekap') loadRekap();
        }

        function showSubject(sub) {
            currentMapel = sub;
            document.querySelectorAll('.subject-content').forEach(c => c.classList.remove('active'));
            document.getElementById(`subject-${sub}`).classList.add('active');
            document.getElementById('tabBi').className = `subject-tab ${sub === 'bi' ? 'active-bi' : ''}`;
            document.getElementById('tabPpkn').className = `subject-tab ${sub === 'ppkn' ? 'active-ppkn' : ''}`;
        }

        // ==================== FORMAT NAMA 2 BARIS ====================
        function formatNama(nama) {
            const parts = nama.trim().split(' ');
            if (parts.length === 1) return { depan: parts[0], belakang: '' };
            return { depan: parts[0], belakang: parts.slice(1).join(' ') };
        }

        function renderNamaCell(nama) {
            const n = formatNama(nama);
            return `<div class="nama-container" title="${nama}">
                <span class="nama-depan">${n.depan}</span>
                ${n.belakang ? `<span class="nama-belakang">${n.belakang}</span>` : ''}
            </div>`;
        }

        // ==================== ABSENSI ====================
        async function loadAbsensiByDate() {
            const tgl = document.getElementById('tanggalAbsensi').value;
            try {
                showLoading();
                const res = await apiGet('getAbsensi', { tanggal: tgl });
                hideLoading();
                
                if (res.success) {
                    if (res.isLibur) {
                        document.getElementById('isLibur').checked = true;
                        document.getElementById('alasanLibur').value = res.alasanLibur;
                        document.getElementById('alasanLibur').disabled = false;
                        showLiburBanner(res.alasanLibur);
                    } else {
                        document.getElementById('isLibur').checked = false;
                        document.getElementById('alasanLibur').value = '';
                        document.getElementById('alasanLibur').disabled = true;
                        hideLiburBanner();
                        if (res.data) absensiData = res.data;
                        else SISWA.forEach((_, i) => absensiData[i] = 'H');
                        renderAbsensi();
                    }
                }
            } catch (e) { hideLoading(); }
        }

        function renderAbsensi() {
            const tbody = document.getElementById('absensiBody');
            tbody.innerHTML = '';
            SISWA.forEach((nama, i) => {
                const st = absensiData[i] || 'H';
                tbody.innerHTML += `<tr>
                    <td class="col-no">${i+1}</td>
                    <td class="col-nama">${renderNamaCell(nama)}</td>
                    <td>
                        <div class="status-group">
                            <button class="status-btn ${st==='H'?'active-h':''}" onclick="setStatus(${i},'H')">H</button>
                            <button class="status-btn ${st==='S'?'active-s':''}" onclick="setStatus(${i},'S')">S</button>
                            <button class="status-btn ${st==='I'?'active-i':''}" onclick="setStatus(${i},'I')">I</button>
                            <button class="status-btn ${st==='A'?'active-a':''}" onclick="setStatus(${i},'A')">A</button>
                        </div>
                    </td>
                    <td><span class="status-badge badge-${getClass(st)}">${getText(st)}</span></td>
                </tr>`;
            });
            updateSummary();
        }

        function setStatus(i, st) { absensiData[i] = st; renderAbsensi(); }
        function getText(s) { return {H:'Hadir',S:'Sakit',I:'Izin',A:'Alpha'}[s]||'Hadir'; }
        function getClass(s) { return {H:'hadir',S:'sakit',I:'izin',A:'alpha'}[s]||'hadir'; }

        function updateSummary() {
            let h=0,s=0,i=0,a=0;
            Object.values(absensiData).forEach(st => {
                if(st==='H')h++; else if(st==='S')s++; else if(st==='I')i++; else if(st==='A')a++;
            });
            const t = SISWA.length;
            document.getElementById('countHadir').textContent = h;
            document.getElementById('countSakit').textContent = s;
            document.getElementById('countIzin').textContent = i;
            document.getElementById('countAlpha').textContent = a;
            document.getElementById('pctHadir').textContent = Math.round(h/t*100)+'%';
            document.getElementById('pctSakit').textContent = Math.round(s/t*100)+'%';
            document.getElementById('pctIzin').textContent = Math.round(i/t*100)+'%';
            document.getElementById('pctAlpha').textContent = Math.round(a/t*100)+'%';
        }

        async function saveAbsensi() {
            const tgl = document.getElementById('tanggalAbsensi').value;
            const isLibur = document.getElementById('isLibur').checked;
            const alasan = document.getElementById('alasanLibur').value;

            if (isLibur && !alasan.trim()) {
                showToast('‚ö†Ô∏è Isi alasan libur!', 'error');
                return;
            }

            try {
                showLoading();
                const res = await apiPost({ action:'saveAbsensi', tanggal:tgl, absensi:absensiData, isLibur, alasanLibur:alasan });
                hideLoading();
                if (res.success) showToast('‚úÖ Absensi tersimpan ke Google Sheets!');
                else showToast('‚ùå Gagal: '+res.message, 'error');
            } catch (e) {
                hideLoading();
                showToast('‚ùå Error koneksi', 'error');
            }
        }

        async function resetAbsensiTanggal() {
            const tgl = document.getElementById('tanggalAbsensi').value;
            if (!confirm(`Reset absensi tanggal ${tgl} dari aplikasi dan Google Sheets?`)) return;
            
            try {
                showLoading();
                const res = await apiPost({ action:'resetAbsensi', tanggal:tgl });
                hideLoading();
                
                if (res.success) {
                    SISWA.forEach((_, i) => absensiData[i] = 'H');
                    document.getElementById('isLibur').checked = false;
                    document.getElementById('alasanLibur').value = '';
                    document.getElementById('alasanLibur').disabled = true;
                    hideLiburBanner();
                    renderAbsensi();
                    showToast('üóëÔ∏è Absensi tanggal ini berhasil direset!', 'info');
                } else showToast('‚ùå Gagal: '+res.message, 'error');
            } catch (e) {
                hideLoading();
                showToast('‚ùå Error koneksi', 'error');
            }
        }

        async function resetSemuaAbsensi() {
            if (!confirm('HAPUS SEMUA DATA ABSENSI dari aplikasi dan Google Sheets?\n\nTindakan ini tidak dapat dibatalkan!')) return;
            
            try {
                showLoading();
                const res = await apiPost({ action:'resetAllAbsensi' });
                hideLoading();
                
                if (res.success) {
                    SISWA.forEach((_, i) => {
                        absensiData[i] = 'H';
                        rekapData[i] = {hadir:0,sakit:0,izin:0,alpha:0};
                    });
                    renderAbsensi();
                    renderRekap(0);
                    document.getElementById('liburBody').innerHTML = '<tr><td colspan="3" style="padding:35px;color:#999;">Belum ada hari libur</td></tr>';
                    showToast('üóëÔ∏è Semua data absensi berhasil dihapus!', 'info');
                } else showToast('‚ùå Gagal: '+res.message, 'error');
            } catch (e) {
                hideLoading();
                showToast('‚ùå Error koneksi', 'error');
            }
        }

        function toggleLibur() {
            const isL = document.getElementById('isLibur').checked;
            document.getElementById('alasanLibur').disabled = !isL;
            if (isL) {
                document.getElementById('alasanLibur').focus();
                showLiburBanner('Masukkan alasan libur...');
            } else hideLiburBanner();
        }

        function showLiburBanner(r) {
            document.getElementById('liburBanner').classList.add('show');
            document.getElementById('liburReason').textContent = r;
            document.getElementById('absensiTableWrapper').style.opacity = '0.3';
            document.getElementById('absensiTableWrapper').style.pointerEvents = 'none';
            document.getElementById('summaryGrid').style.display = 'none';
        }

        function hideLiburBanner() {
            document.getElementById('liburBanner').classList.remove('show');
            document.getElementById('absensiTableWrapper').style.opacity = '1';
            document.getElementById('absensiTableWrapper').style.pointerEvents = 'auto';
            document.getElementById('summaryGrid').style.display = 'grid';
        }

        // ==================== NILAI ====================
        async function loadNilai(mp) {
            try {
                const res = await apiGet('getNilai', { mapel: mp });
                if (res.success && res.data) {
                    nilaiData[mp] = res.data;
                    renderNilai(mp);
                }
            } catch (e) {}
        }

        function renderNilai(mp) {
            const tbody = document.getElementById(`nilai${mp.charAt(0).toUpperCase()+mp.slice(1)}Body`);
            tbody.innerHTML = '';
            SISWA.forEach((nama, i) => {
                const d = nilaiData[mp][i] || {};
                let inp = '';
                ['nh1','nh2','nh3','nh4','nh5','sts','sat'].forEach(f => {
                    const v = d[f] || '';
                    const c = v ? (v<70?'low':'filled') : '';
                    inp += `<td><input type="number" class="nilai-input ${c}" value="${v}" min="0" max="100" onchange="updNilai('${mp}',${i},'${f}',this.value)"></td>`;
                });
                const r = calcRata(d);
                const p = getPred(r);
                const rc = getRataClass(r);
                tbody.innerHTML += `<tr>
                    <td class="col-no">${i+1}</td>
                    <td class="col-nama">${renderNamaCell(nama)}</td>
                    ${inp}
                    <td><span class="rata-cell ${rc}">${r||'-'}</span></td>
                    <td><strong>${r?r+'%':'-'}</strong></td>
                    <td><span class="rata-cell ${rc}">${p}</span></td>
                </tr>`;
            });
        }

        function updNilai(mp, i, f, v) {
            if (!nilaiData[mp][i]) nilaiData[mp][i] = {};
            nilaiData[mp][i][f] = v ? parseInt(v) : '';
            renderNilai(mp);
        }

        function calcRata(d) {
            const v = Object.values(d).filter(x => x !== '' && x !== null && x !== undefined && !isNaN(x));
            return v.length ? Math.round(v.reduce((a,b) => a + Number(b), 0) / v.length) : 0;
        }

        function getPred(n) {
            if (!n) return '-';
            if (n >= 90) return 'A';
            if (n >= 80) return 'B';
            if (n >= 70) return 'C';
            if (n >= 60) return 'D';
            return 'E';
        }

        function getRataClass(n) {
            if (!n) return '';
            if (n >= 90) return 'rata-excellent';
            if (n >= 80) return 'rata-good';
            if (n >= 70) return 'rata-average';
            return 'rata-poor';
        }

        async function saveNilai(mp) {
            try {
                showLoading();
                const res = await apiPost({ action:'saveNilai', mapel:mp, nilai:nilaiData[mp] });
                hideLoading();
                const nama = mp === 'bi' ? 'Bahasa Indonesia' : 'PPKn';
                if (res.success) showToast(`‚úÖ Nilai ${nama} tersimpan ke Google Sheets!`);
                else showToast('‚ùå Gagal', 'error');
            } catch (e) {
                hideLoading();
                showToast('‚ùå Error koneksi', 'error');
            }
        }

        async function resetNilaiMapel(mp) {
            const nama = mp === 'bi' ? 'Bahasa Indonesia' : 'PPKn';
            if (!confirm(`Reset semua nilai ${nama} dari aplikasi dan Google Sheets?`)) return;
            
            try {
                showLoading();
                const res = await apiPost({ action:'resetNilai', mapel:mp });
                hideLoading();
                
                if (res.success) {
                    SISWA.forEach((_, i) => nilaiData[mp][i] = {nh1:'',nh2:'',nh3:'',nh4:'',nh5:'',sts:'',sat:''});
                    renderNilai(mp);
                    showToast(`üóëÔ∏è Nilai ${nama} berhasil direset!`, 'info');
                } else showToast('‚ùå Gagal: '+res.message, 'error');
            } catch (e) {
                hideLoading();
                showToast('‚ùå Error koneksi', 'error');
            }
        }

        // ==================== REKAP ====================
        async function loadRekap() {
            try {
                showLoading();
                const res = await apiGet('getRekapAbsensi');
                hideLoading();
                if (res.success) {
                    rekapData = res.rekap;
                    renderRekap(res.totalHari);
                    renderLibur(res.libur);
                }
            } catch (e) { hideLoading(); }
        }

        function renderRekap(tot) {
            document.getElementById('totalHari').textContent = tot || 0;
            const tbody = document.getElementById('rekapBody');
            tbody.innerHTML = '';
            SISWA.forEach((nama, i) => {
                const d = rekapData[i] || {hadir:0,sakit:0,izin:0,alpha:0};
                const t = d.hadir + d.sakit + d.izin + d.alpha;
                const p = t > 0 ? Math.round(d.hadir / t * 100) : (tot > 0 ? 0 : 100);
                const fc = p >= 90 ? 'fill-excellent' : p >= 80 ? 'fill-good' : p >= 70 ? 'fill-average' : 'fill-poor';
                tbody.innerHTML += `<tr>
                    <td class="col-no">${i+1}</td>
                    <td class="col-nama">${renderNamaCell(nama)}</td>
                    <td><span class="status-badge badge-hadir">${d.hadir}</span></td>
                    <td><span class="status-badge badge-sakit">${d.sakit}</span></td>
                    <td><span class="status-badge badge-izin">${d.izin}</span></td>
                    <td><span class="status-badge badge-alpha">${d.alpha}</span></td>
                    <td><strong>${t}</strong></td>
                    <td>
                        <strong>${p}%</strong>
                        <div class="progress-bar"><div class="progress-fill ${fc}" style="width:${p}%"></div></div>
                    </td>
                </tr>`;
            });
        }

        function renderLibur(list) {
            const tbody = document.getElementById('liburBody');
            if (!list || list.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="padding:35px;color:#999;">Belum ada hari libur</td></tr>';
                return;
            }
            tbody.innerHTML = '';
            list.forEach((item, i) => {
                tbody.innerHTML += `<tr>
                    <td style="font-weight:700;">${i+1}</td>
                    <td>${formatTgl(item.tanggal)}</td>
                    <td style="text-align:left;padding-left:20px;">${item.alasan}</td>
                </tr>`;
            });
        }

        function formatTgl(d) {
            const days = ['Minggu','Senin','Selasa','Rabu','Kamis','Jumat','Sabtu'];
            const mons = ['Jan','Feb','Mar','Apr','Mei','Jun','Jul','Ags','Sep','Okt','Nov','Des'];
            const dt = new Date(d);
            return `${days[dt.getDay()]}, ${dt.getDate()} ${mons[dt.getMonth()]} ${dt.getFullYear()}`;
        }
    </script>
</body>
</html>